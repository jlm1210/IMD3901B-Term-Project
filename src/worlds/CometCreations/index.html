<html>
  <head>
    <meta charset="utf-8">

    <!-- Circles' head scripts [REQUIRED] -->
    <circles-start-scripts/>
    <!-- Physics script goes after the Circles' head scripts [IMPORTANT]-->
    <script src="/global/js/libs/aframe-physics-system.min.js"></script>
    <!-- add your custom scripts here -->
    <link rel="stylesheet" href="css/styles.css">

  </head>
  <body>

    <!--settings UI for after initial circlesXR UI-->
    <div id="firstUI" class="settings-overlay">
      <div class="center">
        <button class="settings-button" onclick="nextUI(1);">SINGLEPLAYER</button>
        <button class="settings-button" onclick="nextUI(2);">MULTIPLAYER</button>
      </div>
     </div>
     
     <div id="secondUI" class="settings-overlay">
      <div class="center">
        <img id="loading-animation" src="https://cdn.glitch.com/4d85200f-900f-4f4a-b950-82c4af80c1fb%2Floader.gif?v=1611262527887">
         <h1>LANGUAGE</h1>
           <div>
           <input type="radio" name="lang" value="en" class="lang" checked/>
           <label for="radio1">ENGLISH</label>
           </div>
   
           <div>
           <input type="radio" name="lang" value="fr" class="lang"/>
           <label for="radio2">FRENCH</label>
           </div>
        <h1>OTHER ACCESSIBILITY OPTIONS HERE</h1>
   
        <button class="settings-button" onclick="closeUI();">CONTINUE</button>
      </div>
     </div>

    <!--game UI-->
    <div id="gameUI">
      <div>
        <h3 id="info">KNOWLEDGE</h3>
        <div id="team">
          <h3>PLAYERS</h3>
        </div>
      </div>
     </div>
     
    <script>
      //global values
      var userLang = "en";
      var jsonFile = "./language/en.JSON";
      var jsonData = "";
      var numGroups = 1;
      var isMultiPlayer = false;
      const maxMultiPlayers = 4;
      var objectKnowledge = [];
      var numPlayers = 0;
      var usersInRoom = [];


      window.onload = (event) => {
        console.log("page is fully loaded");
        //only show setup screens once
        if(!window.location.href.includes("explore")){
          document.querySelector('#firstUI').style.display='none';
          document.querySelector('#secondUI').style.display='block';
          console.log(isMultiPlayer);
        } 
      };
      

      //this will setup singleplayer vs multiplayer
      function nextUI(flag){
        document.querySelector('#firstUI').style.display='none';
        if(flag===1){
          console.log("singleplayer");
          isMultiPlayer = false;
          document.querySelector('#secondUI').style.display='block';

        } else {
          console.log("multiplayer");
          document.querySelector('#secondUI').style.display='block';
          isMultiPlayer = true;

          let URL = window.location.href;
          let newGrp = "group" + numGroups;
          URL = URL.replace("explore", newGrp);

          //send user to new group
          window.location.href = URL;

          console.log(CIRCLES.getCirclesGroupName());
        }
      }

      //this will setup accessibility settings
      function closeUI(){
        var languages = document.querySelectorAll(".lang");
        for(let i=0; i < languages.length; i++){

          //fetch the JSON file of the correct language
          if(languages[i].checked === true){
              userLang = languages[i].value;
              var jsonFile = "./language/"+ userLang + ".JSON";
              fetch(jsonFile)
                .then((res) => {
                    if (!res.ok) {
                        throw new Error
                            (`HTTP error! Status: ${res.status}`);
                    }
                    return res.json();
                })
                .then((data) => {
                  jsonData = data;
                 // console.log(jsonData);
                })
                .catch((error) => 
                       console.error("Unable to fetch data:", error));
          }
        } 
        
       //------------MAIN GAME LOOP----------------
       //wait for circles to load in properly
      if(CIRCLES.isReady()){

        //switch visible overlays
        document.querySelector('#secondUI').style.display='none';
        document.querySelector('#gameUI').style.display='block';

        //get welcome text
        window.setInterval(printy, 1000);

        function printy(){
          //setup text
          const welcome = document.getElementById('welcome_description');
          welcome.setAttribute('circles-description', {title_text_front:'Welcome!', description_text_front:`${jsonData.HUBText.Welcome}`, description_text_back:`${jsonData.HUBText.Welcome}`, lookAtCamera:true});
        }

        //make a unique colour for each avatar
        var rCol = 0;
        var gCol = 255;
        var bCol = 0;

        window.setInterval(avatarUI ,1000);        

        function avatarUI(){
            //get all avatars in the group to show in the UI
            var allAvatars = CIRCLES.getNAFAvatarElements();

            //if another player has joined, get the UI again
            if(allAvatars.length > numPlayers){

              for(let i = numPlayers; i < allAvatars.length; i++){

                rCol = Math.floor(Math.random() * 255);
                gCol = Math.floor(Math.random() * 255);
                bCol = Math.floor(Math.random() * 255);

                //2 and 3rd children are head and body
                allAvatars[i].children[2].setAttribute('circles-color', {alpha: 1, color:`rgb(${rCol}, ${gCol}, ${bCol})`});
                allAvatars[i].children[3].setAttribute('circles-color', {alpha: 1, color:`rgb(${rCol}, ${gCol}, ${bCol})`});

                var playerText = document.createElement("h5");
                playerText.innerHTML = `Player ${i+1}`;
                playerText.style.backgroundColor = `rgb(${rCol}, ${gCol}, ${bCol})`;
                playerText.setAttribute('id',`player${i}`);
                document.querySelector("#team").appendChild(playerText);

              }
              numPlayers = allAvatars.length;
            } else if(allAvatars.length < numPlayers) {
              var UI = document.querySelector("#team");
              UI.removeChild(UI.lastChild);
              numPlayers = allAvatars.length;
            }
          }

          console.log(CIRCLES.getCirclesGroupName());


          var currAvatar = CIRCLES.getAvatarRigElement();
          currAvatar.setAttribute('trigger', {});

          //probably not the greatest way to do this
          AFRAME.registerComponent('trigger', {
          init: function () {
            var el = this.el;
            var pos = el.getAttribute('position');
            var boxPos = document.querySelector('#labTrigger').getAttribute('position');
            console.log(pos);
            console.log(boxPos);
            
            // Check for intersection every 100 milliseconds
            setInterval(function () {

                if(pos.z < boxPos.z){
                  //console.log("in the room");
                  usersInRoom.push(el);
                }

            }, 100);
          }
        });

        //get knowledge of objects when picked up
        var temp = document.querySelector("#object");
        temp.addEventListener(CIRCLES.EVENTS.PICKUP_THIS_OBJECT, (e) => {
          var currentObj = {title: temp.getAttribute('circles-artefact').title, desc: temp.getAttribute('circles-artefact').description}

          //check if we've already pikced up this object
          const foundObject = objectKnowledge.find(obj => obj.id === currentObj.id && obj.name === currentObj.name);

          if(!foundObject){
            objectKnowledge.push(currentObj);
          }
        });



        setInterval(function () {
          //add knowledge to the UI
          var numUI = document.querySelector("#info").children.length;

          if(numUI < objectKnowledge.length){
            for(let i = numUI; i < objectKnowledge.length; i++){
              var newEl = document.createElement("h4");
              newEl.innerHTML = objectKnowledge[i].title;
              var innerEl = document.createElement("h6");
              innerEl.innerHTML = objectKnowledge[i].desc;
              newEl.appendChild(innerEl);
              document.querySelector("#info").appendChild(newEl);
            }
          }

        }, 100);

      } else {
        document.querySelector('#loading-animation').style.display='block';
      }

    }


    </script>

    <!-- this is used to create our enter UI that creates a 2D overlay to capture a user gesture for sound/mic access etc. -->
    <circles-start-ui/>

    <!-- a-scene with 'circles-properties' component [REQUIRED] -->
    <a-scene circles_scene_properties networked-scene="room: explore; connectOnLoad: false;">
      <a-assets>
        <!-- add your assets here. Note that you can use relative links or absolute paths to your world -->
        <!-- credit: HDRMaps @ https://hdrmaps.com/above-the-clouds/ -->
        <img id='skyMap' src='assets/textures/086_hdrmaps_com_free_above_clouds.jpg' crossorigin="anonymous">

        <!-- add our music and audio here -->

        <!-- add our gltf models here
        <a-asset-item id="roomLayout" src="assets/models/Room/BothRoomsWTexture4.gltf" response-type="arraybuffer"/>
        -->
        <a-asset-item id="tempObj" src="assets/textures/flask1.gltf" response-type="arraybuffer"/>

        <!-- loading navmesh. Following instructiosn from here: https://github.com/n5ro/aframe-extras/tree/master/src/pathfinding -->
       
        <!-- Circles' built-in assets [REQUIRED] -->
        <circles-assets/>
      </a-assets>

      <!-- Circles' built-in manager and avatar [REQUIRED] -->
      <circles-manager-avatar/>

      <!-- just creating an entity that connects many elements together -->
      <a-entity id="game_manager" lights-interactive></a-entity>

      <!-- room with some checkpoints 
      <a-entity id="room"
            position="3.5 -0.4 2.485"
            rotation="0 0 0"
            scale="2 2 2"
            gltf-model="#roomLayout">
      </a-entity>
      -->

    <a-entity id="object"
          position="5 1.5 5"
          rotation="0 0 0"
          scale="10 10 10"
          gltf-model="#tempObj"
          material="color: rgb(0,0,0)"
          circles-interactive-object="type:highlight; highlight_color: rgb(0,0,255)"
          circles-artefact="inspectPosition:0 0 0; inspectRotation:0 0 0; inspectScale: 30 30 30;
                                  textRotationY:90.0; labelLookAt:true; descriptionLookAt:true; label_offset:0.0 1.0 0.0; label_arrow_position:down;
                                  title: OBJECT;
                                  description:object text;
                                  title_back: OBJECT;
                                  description_back: object text 2;
                                  description_offset:0 0.5 0;
                                  desc_arrow_position:down;
                                  label_text:Object;"
                circles-pickup-networked>
    </a-entity>

      <!--room trigger box-->
      <a-entity id="labTrigger" position="0.111 1.498 5.411" scale="2 2 1" geometry="primitive:box; width:1; height: 1; depth:1;" material="opacity: 0;"></a-entity>

      <!--teleport points-->
      <a-entity circles-checkpoint circles-spawnpoint position="-8.79 0.592 9.588"></a-entity>
      <a-entity circles-checkpoint position="-0.87 0.592 9.841"></a-entity>
      <a-entity circles-checkpoint position="0.728 0.592 1.207"></a-entity>
      <a-entity circles-checkpoint position="6.275 0.592 1.108"></a-entity>

      <a-entity id="welcome_description" position="-10.3 2 8.648" rotation="0 0 0"></a-entity>

      <!-- example "artefact" 
      <a-entity id="Artefact-Gem"
                position="-4.7 2.145 12.27" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:octahedron; radius:0.5;"
                material="color:rgb(255, 100, 20); roughness:0.2; metalness:0.8;"
                circles-sphere-env-map="src:#skyMap"
                circles-artefact="inspectPosition:0 0 0; inspectRotation:0 0 0; inspectScale:0.8 0.8 0.8;
                                  textRotationY:90.0; labelLookAt:true; descriptionLookAt:true; label_offset:0.0 1.0 0.0; label_arrow_position:down;
                                  title:[~20-25 chars] Title Front;
                                  description:[~240-280 chars]  This is the FRONT text that will display when an object is picked up. Adjust scale size and text rotation properties to make more visible.;
                                  title_back:[~20-25 chars] Title Back;
                                  description_back:[~240-280 chars] This is the back/secondary text that will display when you rotate the description bubble.;
                                  description_offset:0 0.5 0;
                                  desc_arrow_position:down;
                                  label_text:Gem;"
                circles-pickup-networked></a-entity> <!-- circles-pickup-networked allows this to be seen and interacted with other players -->

      <!-- sky and lights -->
      <a-entity id="sunlight" position="0 20 0" rotation="40 0 0" 
                light="type:directional; intensity:1; color:#d5e4f5; castShadow:true"></a-entity>
      <a-entity light="type:hemisphere; color:#FFFFFF; groundColor:#BCE2F4; intensity:0.5"></a-entity>

      <a-entity id='skyBox'
                rotation='0 200 0'
                geometry='primitive:sphere; radius:50; segments-height:24; segments-width:24;'
                material='shader:flat; src:#skyMap; side:back;'>
      </a-entity>
    </a-scene>

    <!-- Circles' end scripts [REQUIRED] -->
    <circles-end-scripts/>
  </body>
</html>
